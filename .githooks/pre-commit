#!/bin/sh
set -e

# Get changed files
STAGED_FILES=$(git diff --cached --name-only)

# Define patterns
CORE_PATTERN="^packages/|^package.json|^tsconfig.json|^.eslintrc.cjs"
DOCS_PATTERN="^docs/"
EXAMPLES_PATTERN="^examples/"

# Function to check if files matching pattern changed
has_changes() {
  echo "$STAGED_FILES" | grep -q "$1"
}

# Run core checks if core files changed
if has_changes "$CORE_PATTERN"; then
  echo "üì¶ Core changes detected. Running core checks..."
  echo "  - Format"
  bun run format
  echo "  - Lint"
  bun run lint:fix
  echo "  - Typecheck"
  bun run typecheck
  echo "  - Test"
  bun run test
fi

# Run doc checks if docs changed
if has_changes "$DOCS_PATTERN"; then
  echo "üìö Docs changes detected. Running doc checks..."
  echo "  - Build"
  bun run docs:build
  echo "  - Snippets Typecheck"
  bun run docs:snippets:typecheck
fi

# Run example checks if examples changed
if has_changes "$EXAMPLES_PATTERN"; then
  echo "üß™ Example changes detected. Running example checks..."
  echo "  - Typecheck Examples"
  bun run typecheck:examples
fi

# Check for unstaged changes after auto-formatting
if [ -n "$STAGED_FILES" ]; then
  CHANGED=$(git diff --name-only -- $STAGED_FILES)
  if [ -n "$CHANGED" ]; then
    echo "‚ö†Ô∏è  Staged files changed after formatting/lint. Please review and re-stage:"
    echo "$CHANGED"
    exit 1
  fi
fi
