#!/bin/sh
set -e

STAGED_FILES=$(git diff --cached --name-only -z)

echo "pre-commit: format"
bun run format
echo "pre-commit: lint:fix"
bun run lint:fix
echo "pre-commit: typecheck"
bun run typecheck
echo "pre-commit: test"
bun run test

if [ -n "$STAGED_FILES" ]; then
  CHANGED=$(printf "%s" "$STAGED_FILES" | xargs -0 git diff --name-only --)
  if [ -n "$CHANGED" ]; then
    echo "pre-commit: staged files changed after formatting/lint. Please review and re-stage."
    echo "$CHANGED"
    echo "hint: git add $CHANGED"
    exit 1
  fi
fi
